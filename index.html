<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brendan Campbell - Interactive CV</title>
    <meta name="description" content="Explore Brendan Campbell's professional journey through an innovative 3D planet interface">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" as="script">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- CSS Files - Component-based styling -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/responsive.css">
    <script type="module" src="data/ContentManager.js"></script>
    <link rel="stylesheet" href="css/content-enhancements.css">
    
    <style>
        /* Critical inline styles for loading screen */
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: var(--z-background);
            background-image: url('./assets/images/backgrounds/StarBackground1.jpg');
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
        }

        #space-canvas {
    width: 100%;
    height: 100%;
    display: block;
    cursor: default; /* ADDED: Default cursor for canvas */
}

#space-canvas.hovering-interactive {
    cursor: pointer; /* ADDED: Only show pointer when hovering interactive elements */
}

#space-canvas.planet-rotating {
    cursor: move;
}

        /* Scene container */
        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: var(--z-scene);
        }
    </style>
</head>
<body>
    <!-- Background Container -->
    <div class="background-container"></div>

    <!-- ADD THIS NEW BLACK SCREEN DIV -->
    <div id="travel-black-screen" class="travel-black-screen hidden"></div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="loader">
                <img src="./assets/images/logos/LogoBW.png" alt="Brendan Campbell Logo" class="loader-logo">
            </div>
            <p class="loading-text">Preparing your journey through Brendan's professional solar system...</p>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- WebGL Error Fallback -->
    <div id="webgl-error" class="overlay hidden">
        <div class="modal">
            <div class="modal-close" onclick="this.parentElement.parentElement.classList.add('hidden')">&times;</div>
            <h2 class="heading-secondary">WebGL Not Supported</h2>
            <p class="text-secondary">Your browser doesn't support WebGL, which is required for the 3D experience.</p>
            <p class="text-muted">Please try using a modern browser like Chrome, Firefox, or Safari.</p>
        </div>
    </div>

    <!-- Controls Info Panel -->
    <div id="controls-info" class="panel-holographic-navigation ui-panel-top-right navigation-panel">
    <div class="ui-panel-header navigation-header">
        <div class="ui-panel-title">üéÆ Navigation</div>
        <button class="mobile-nav-toggle" id="mobile-nav-toggle">
            <span class="nav-arrow">‚ñº</span>
        </button>
    </div>
    <div class="ui-panel-body navigation-body">
        <div class="text-sm text-secondary">‚Ä¢ Drag planet: Rotate planet</div>
        <div class="text-sm text-secondary">‚Ä¢ Click planet: Travel to planet</div>
        <div class="text-sm text-secondary">‚Ä¢ Hover planet: Show info</div>
    </div>
</div>

    <!-- Planet Info Panel -->
    <div id="planet-info" class="panel-holographic panel-bottom-left hidden">
        <div class="panel-header">
            <div id="planet-name" class="panel-title">Planet Name</div>
        </div>
        <div class="panel-body">
            <div id="planet-description" class="text-sm">Planet description goes here</div>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app">
        <!-- 3D Scene Container -->
        <div id="scene-container">
            <canvas id="space-canvas" class="cursor-grab"></canvas>
        </div>

        <!-- Content Overlay (Used by Travel System) - UPDATED STRUCTURE -->
        <div id="content-overlay" class="overlay hidden">
            <div class="modal modal-holographic modal-with-pinned-footer">
                <button id="close-content" class="modal-close">&times;</button>
                
                <div class="modal-content-wrapper">
                    <div class="modal-header flex items-center gap-lg">
                        <h2 id="content-title" class="heading-primary">Content Title</h2>
                    </div>
                    
                    <div id="content-body" class="modal-body">
                        <!-- Content will be dynamically inserted here -->
                    </div>
                </div>
                
                <div class="modal-footer-pinned">
                    <button id="return-to-orbit" class="btn btn-secondary">Return to Orbit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="module" src="components/planets/CareerPlanet.js"></script>
    <script type="module" src="components/planets/EducationWorld.js"></script>
    <script type="module" src="components/planets/SkillsAstroid.js"></script>
    <script type="module" src="components/planets/AchievementStar.js"></script>
    <script type="module" src="components/planets/CommunitySphere.js"></script>
    <script type="module" src="components/planets/ContactStation.js"></script>
    <script type="module" src="components/planets/PortfolioNebula.js"></script>
    <script type="module" src="components/spaceship/Spaceship.js"></script>
    <script type="module" src="components/portfolio/PortfolioViewer.js"></script>
    
    <script type="module">
        import { ContentManager } from './data/ContentManager.js';
        import { CareerPlanet } from './components/planets/CareerPlanet.js';
        import { EducationWorld } from './components/planets/EducationWorld.js';
        import { SkillsAstroid } from './components/planets/SkillsAstroid.js';
        import { AchievementStar } from './components/planets/AchievementStar.js';
        import { CommunitySphere } from './components/planets/CommunitySphere.js';
        import { ContactStation } from './components/planets/ContactStation.js';
        import { PortfolioNebula } from './components/planets/PortfolioNebula.js';
        import { Spaceship } from './components/spaceship/Spaceship.js';
        import { PortfolioViewer } from './components/portfolio/PortfolioViewer.js';
        
        // TRAVEL SYSTEM IMPORT
        import { TravelSystem } from './components/travel/TravelSystem.js';

        // ENHANCED MODAL SYSTEM
        
        /**
         * Planet name mappings for modal headers
         */
        const PLANET_NAMES = {
            'work-planet': 'Career Planet',
            'education-planet': 'Knowledge World', 
            'skills-planet': 'Skills Asteroid',
            'projects-planet': 'Achievement Star',
            'community-planet': 'Community Sphere',
            'contact-planet': 'Contact Station',
            'portfolio-nebula': 'Portfolio Nebula'
        };

        /**
         * Planet color mappings for headers
         */
        const PLANET_COLORS = {
            'work-planet': 'planet-career',
            'education-planet': 'planet-education', 
            'skills-planet': 'planet-skills',
            'projects-planet': 'planet-projects',
            'community-planet': 'planet-community',
            'contact-planet': 'planet-contact',
            'portfolio-nebula': 'planet-portfolio'
        };

        /**
         * Enhanced method to update content modal with planet-themed styling
         */
         function updateContentModal(title, content, planetId) {
            const contentTitle = document.getElementById('content-title');
            const contentBody = document.getElementById('content-body');
            const modal = document.querySelector('.modal');
            
            if (contentTitle) {
                // Use planet name instead of section title
                const planetName = PLANET_NAMES[planetId] || title;
                contentTitle.textContent = planetName;
                
                // Remove all previous planet color classes
                contentTitle.classList.remove(
                    'planet-career', 'planet-education', 'planet-skills', 
                    'planet-projects', 'planet-community', 'planet-contact', 'planet-portfolio'
                );
                
                // Add the appropriate planet color class
                const colorClass = PLANET_COLORS[planetId];
                if (colorClass) {
                    contentTitle.classList.add(colorClass);
                }
            }
            
            if (contentBody) {
                contentBody.innerHTML = content;
            }
            
            // PORTFOLIO-SPECIFIC MODAL STYLING
            if (modal) {
                // Remove existing modal classes
                modal.classList.remove('modal-with-pinned-footer', 'modal-portfolio');
                
                if (planetId === 'portfolio-nebula') {
                    // Apply portfolio-specific full-screen modal
                    modal.classList.add('modal-portfolio');
                    console.log('üñºÔ∏è Applied full-screen portfolio modal styling');
                } else {
                    // Apply standard modal with pinned footer
                    modal.classList.add('modal-with-pinned-footer');
                }
            }
            
            // Update footer for travel mode
            const modalFooter = document.querySelector('.modal-footer-pinned');
            if (modalFooter) {
                modalFooter.innerHTML = `
                    <button id="return-to-orbit" class="btn btn-secondary">Return to Orbit</button>
                `;
                
                // Re-attach event listener
                const returnBtn = document.getElementById('return-to-orbit');
                if (returnBtn) {
                    returnBtn.addEventListener('click', () => {
                        if (window.spaceCVApp && window.spaceCVApp.travelSystem) {
                            window.spaceCVApp.travelSystem.returnToOrbit();
                        } else {
                            // Fallback
                            window.spaceCVApp.hideContent();
                        }
                    });
                }
            }
        }

        /**
         * Enhanced planet info positioning system
         */
        class EnhancedPlanetInfoPositioning {
            constructor() {
                this.planetInfo = document.getElementById('planet-info');
                this.camera = null;
                this.scene = null;
                
                // Planet position mappings (approximate 2D positions)
                this.planetPositions = {
                    'community-planet': { x: -180, y: 20, side: 'below' },
                    'projects-planet': { x: -90, y: 50, side: 'below' },
                    'work-planet': { x: 0, y: 60, side: 'below' },
                    'education-planet': { x: 90, y: 50, side: 'below' },
                    'skills-planet': { x: 180, y: 20, side: 'below' },
                    'contact-planet': { x: -120, y: -60, side: 'right' }, // Exception: right side
                    'portfolio-nebula': { x: 0, y: 5, side: 'below' }
                };
                
                this.init();
            }
            
            init() {
                console.log('üéØ Enhanced Planet Info Positioning initialized');
            }
            
            /**
             * Set camera and scene references
             */
            setReferences(camera, scene) {
                this.camera = camera;
                this.scene = scene;
            }
            
            /**
             * Position planet info relative to planet
             */
            positionPlanetInfo(planetId, planetGroup) {
                if (!this.planetInfo || !this.camera) return;
                
                const planetData = this.planetPositions[planetId];
                if (!planetData) return;
                
                try {
                    // Get planet's screen position
                    const planetPosition = planetGroup.position.clone();
                    planetPosition.project(this.camera);
                    
                    // Convert to screen coordinates
                    const screenX = (planetPosition.x * 0.5 + 0.5) * window.innerWidth;
                    const screenY = (-planetPosition.y * 0.5 + 0.5) * window.innerHeight;
                    
                    // Position based on planet's designated side
                    this.positionInfoPanel(screenX, screenY, planetData.side, planetId);
                    
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not position planet info:', error);
                    // Fallback to default positioning
                    this.positionInfoPanel(200, 200, 'below', planetId);
                }
            }
            
            /**
             * Position the info panel based on calculated screen coordinates
             */
            positionInfoPanel(screenX, screenY, side, planetId) {
                const panelWidth = 260;
                const panelHeight = 120;
                const margin = 20;
                
                let finalX, finalY;
                
                // Clear previous positioning classes
                this.planetInfo.classList.remove('position-below', 'position-right', 'position-left');
                
                switch (side) {
                case 'right':
                    // Position to the right (for Contact Station) - MOVED FURTHER RIGHT
                    finalX = Math.min(screenX + 120, window.innerWidth - panelWidth - margin);
                    finalY = Math.max(margin, Math.min(screenY - panelHeight/2, window.innerHeight - panelHeight - margin));
                    this.planetInfo.classList.add('position-right');
                    break;
        
                case 'left':
                    // Position to the left - MOVED FURTHER LEFT
                    finalX = Math.max(margin, screenX - panelWidth - 120);
                    finalY = Math.max(margin, Math.min(screenY - panelHeight/2, window.innerHeight - panelHeight - margin));
                    this.planetInfo.classList.add('position-left');
                    break;
        
                case 'below':
                default:
                    // Position below the planet (default) - MOVED FURTHER DOWN
                    finalX = Math.max(margin, Math.min(screenX - panelWidth/2, window.innerWidth - panelWidth - margin));
                    finalY = Math.min(screenY + 100, window.innerHeight - panelHeight - margin);
                    this.planetInfo.classList.add('position-below');
                    break;
            }
                
                // Apply positioning
                this.planetInfo.style.left = `${finalX}px`;
                this.planetInfo.style.top = `${finalY}px`;
                this.planetInfo.style.bottom = 'auto';
                this.planetInfo.style.right = 'auto';
                
                console.log(`üéØ Positioned ${planetId} info panel at (${finalX}, ${finalY}) - ${side}`);
            }
            
            /**
             * Show planet info with enhanced positioning
             */
            showPlanetInfo(planet) {
                if (!this.planetInfo) return;
                
                const planetName = document.getElementById('planet-name');
                const planetDescription = document.getElementById('planet-description');
                
                const info = planet.getInfo();
                
                // Use planet display names
                const displayName = PLANET_NAMES[planet.id] || info.name;
                
                if (planetName) planetName.textContent = displayName;
                if (planetDescription) planetDescription.textContent = info.description;
                
                // Position the info panel
                this.positionPlanetInfo(planet.id, planet.getGroup());
                
                // Show with animation
                this.planetInfo.classList.remove('hidden');
            }
            
            /**
             * Show nebula info with enhanced positioning
             */
            showNebulaInfo(nebula) {
                if (!this.planetInfo) return;
                
                const planetName = document.getElementById('planet-name');
                const planetDescription = document.getElementById('planet-description');
                
                if (planetName) planetName.textContent = 'Portfolio Nebula';
                if (planetDescription) planetDescription.textContent = 'A mystical collection of Brendan\'s creative work and design portfolio';
                
                // Position for nebula
                this.positionPlanetInfo('portfolio-nebula', nebula.getGroup());
                
                // Show with animation
                this.planetInfo.classList.remove('hidden');
            }
            
            /**
             * Hide planet info
             */
            hidePlanetInfo() {
                if (this.planetInfo) {
                    this.planetInfo.classList.add('hidden');
                }
            }
        }

        // RETURN TO ORBIT EVENT HANDLER
        function setupReturnToOrbitHandler() {
            // Use event delegation to catch dynamically created buttons
            document.addEventListener('click', function(event) {
                if (event.target && event.target.id === 'return-to-orbit') {
                    console.log('üîÑ Return to Orbit button clicked');
                    
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Call the travel system's return method
                    if (window.spaceCVApp && window.spaceCVApp.travelSystem) {
                        window.spaceCVApp.travelSystem.returnToOrbit();
                    } else {
                        console.error('‚ùå Travel system not found');
                    }
                }
            });
            
            console.log('‚úÖ Return to Orbit event handler established');
        }

        // Complete Space CV Application
        class CompletSpaceCVApp {
    constructor() {
        this.scene = null;
        this.camera = null;
        this.renderer = null;
        this.planets = [];
        this.portfolioNebula = null;
        this.spaceship = null;
        this.clock = new THREE.Clock();
        this.isLoaded = false;
        this.animationRunning = false;
        
        // Mouse interaction
        this.mouse = { x: 0, y: 0 };
        this.isDragging = false;
        this.dragDistance = 0;
        this.lastMousePos = { x: undefined, y: undefined };
        this.mouseDownTime = 0;
        this.raycaster = new THREE.Raycaster();
        
        // Planet-specific rotation
        this.rotatingPlanet = null;
        this.isRotatingPlanet = false;
        
        // Current content
        this.currentContent = null;
        
        // TRAVEL SYSTEM
        this.travelSystem = null;
        
        // PORTFOLIO VIEWER
        this.portfolioViewer = null;

        // ENHANCED POSITIONING SYSTEM
        this.enhancedPositioning = null;
        
        // CONTENT MANAGER - NEW!
        this.contentManager = new ContentManager();
        
        // Bound event handlers for cleanup
        this.boundMouseDown = null;
        this.boundMouseMove = null;
        this.boundMouseUp = null;
        this.boundMouseClick = null;
        
        this.init();
    }

    async init() {
    console.log('üöÄ Initializing Complete Space CV Application...');
    
    if (!this.checkWebGLSupport()) {
        this.showWebGLError();
        return;
    }

    // Load content first
    await this.initializeContent();

    this.startLoadingSequence();
    
    setTimeout(() => {
        this.initScene();
    }, 500);
    
    this.setupEventListeners();
}

async initializeContent() {
    try {
        await this.contentManager.loadContent();
        console.log('‚úÖ CV content loaded successfully');
    } catch (error) {
        console.error('‚ùå Content loading failed, using fallback:', error);
    }
}

            checkWebGLSupport() {
                try {
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                    return !!context;
                } catch (e) {
                    return false;
                }
            }

            startLoadingSequence() {
                const loadingScreen = document.getElementById('loading-screen');
                const progressBar = document.querySelector('.progress-fill');
                
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15 + 5;
                    
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(progressInterval);
                        this.completeLoading();
                    }
                    
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                    }
                }, 200);
            }

            completeLoading() {
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loading-screen');
                    if (loadingScreen) {
                        loadingScreen.classList.add('fade-out');
                        setTimeout(() => {
                            loadingScreen.classList.add('hidden');
                        }, 500);
                    }
                    this.isLoaded = true;
                }, 1000);
            }

            initScene() {
                try {
                    this.setupRenderer();
                    this.setupScene();
                    this.setupCamera();
                    this.setupLighting();
                    this.createPlanets();
                    this.createPortfolioNebula();
                    this.createSpaceship();
                    
                    // INITIALIZE ENHANCED POSITIONING SYSTEM
                    this.enhancedPositioning = new EnhancedPlanetInfoPositioning();
                    this.enhancedPositioning.setReferences(this.camera, this.scene);
                    console.log('üéØ Enhanced positioning system initialized');
                    
                    // INITIALIZE TRAVEL SYSTEM AFTER SCENE SETUP
                    this.travelSystem = new TravelSystem(this);
                    console.log('üöÄ Travel System initialized');
                    
                    this.startAnimation();
                    
                    console.log('‚úÖ Complete scene initialized successfully');
                } catch (error) {
                    console.error('‚ùå Failed to initialize scene:', error);
                    this.showWebGLError();
                }
            }

            setupRenderer() {
                const canvas = document.getElementById('space-canvas');
                
                this.renderer = new THREE.WebGLRenderer({
                    canvas: canvas,
                    antialias: true,
                    alpha: true
                });
                
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                this.renderer.setClearColor(0x000000, 0);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            }

            setupScene() {
                this.scene = new THREE.Scene();
            }

            setupCamera() {
                this.camera = new THREE.PerspectiveCamera(
                    60,
                    window.innerWidth / window.innerHeight, 
                    0.1, 
                    2000
                );
                this.camera.position.set(0, 30, 140);
                this.camera.lookAt(0, 0, 0);
            }

            setupLighting() {
                const ambientLight = new THREE.AmbientLight(0x404040, 0.4);
                this.scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(100, 100, 100);
                directionalLight.castShadow = true;
                this.scene.add(directionalLight);

                this.createStarField();
            }

            createStarField() {
                const starGeometry = new THREE.BufferGeometry();
                const starCount = 2000;
                const positions = new Float32Array(starCount * 3);

                for (let i = 0; i < starCount; i++) {
                    positions[i * 3] = (Math.random() - 0.5) * 2000;
                    positions[i * 3 + 1] = (Math.random() - 0.5) * 2000;
                    positions[i * 3 + 2] = (Math.random() - 0.5) * 2000;
                }

                starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

                const starMaterial = new THREE.PointsMaterial({
                    color: 0xFFFFFF,
                    size: 1,
                    transparent: true,
                    opacity: 0.8
                });

                const starField = new THREE.Points(starGeometry, starMaterial);
                this.scene.add(starField);
            }

            // Planet positions with spaceship and nebula moved down
            createPlanets() {
                console.log('üåç Creating planets in wide arc formation...');
                
                // 1. Far Left - Community Planet
                const communitySphere = new CommunitySphere(this.scene, { x: -180, y: 20, z: -100 });
                this.planets.push(communitySphere);
                
                // 2. Upper-left - Achievement Star
                const achievementStar = new AchievementStar(this.scene, { x: -90, y: 50, z: -120 });
                this.planets.push(achievementStar);
                
                // 3. Top center - Career Planet
                const careerPlanet = new CareerPlanet(this.scene, { x: 0, y: 60, z: -140 });
                this.planets.push(careerPlanet);
                
                // 4. Upper-right - Education World
                const educationWorld = new EducationWorld(this.scene, { x: 90, y: 50, z: -120 });
                this.planets.push(educationWorld);
                
                // 5. Far Right - Skills Asteroid
                const skillsAsteroid = new SkillsAstroid(this.scene, { x: 180, y: 20, z: -100 });
                this.planets.push(skillsAsteroid);
                
                // Contact Station
                const contactStation = new ContactStation(this.scene, { x: -120, y: -60, z: -30 });
                this.planets.push(contactStation);
                
                console.log('‚úÖ Created 6 planets in proper wide arc formation');
            }

            // Portfolio Nebula moved down
            createPortfolioNebula() {
                console.log('üíé Creating Portfolio Nebula...');
                
                // MOVED DOWN: Position lower (was y: 15, now y: 5)
                this.portfolioNebula = new PortfolioNebula(this.scene, { x: 0, y: 5, z: 20 });
                
                console.log('‚úÖ Portfolio Nebula created and positioned lower');
            }

            // Spaceship moved down significantly
            createSpaceship() {
                // MOVED DOWN: Position much lower (was y: 5, now y: -15)
                this.spaceship = new Spaceship(this.scene, { x: 0, y: 0, z: 90 });
                console.log('üöÄ Created spaceship in lower bottom center position');
            }

            setupEventListeners() {
                window.addEventListener('resize', this.onWindowResize.bind(this));
                
                const canvas = document.getElementById('space-canvas');
                this.boundMouseDown = this.onMouseDown.bind(this);
                this.boundMouseMove = this.onMouseMove.bind(this);
                this.boundMouseUp = this.onMouseUp.bind(this);
                this.boundMouseClick = this.onMouseClick.bind(this);
                
                canvas.addEventListener('mousedown', this.boundMouseDown);
                canvas.addEventListener('mousemove', this.boundMouseMove);
                canvas.addEventListener('mouseup', this.boundMouseUp);
                canvas.addEventListener('click', this.boundMouseClick);

                // Content overlay events - UPDATED TO USE RETURN TO ORBIT LOGIC
                document.getElementById('close-content').addEventListener('click', () => {
                    if (this.travelSystem && this.travelSystem.isTraveling()) {
                        this.travelSystem.returnToOrbit();
                    } else {
                        this.hideContent();
                    }
                });
            }

            onWindowResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            onMouseDown(event) {
                this.isDragging = false;
                this.dragDistance = 0;
                this.lastMousePos.x = event.clientX;
                this.lastMousePos.y = event.clientY;
                this.mouseDownTime = Date.now();
                
                this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                
                this.rotatingPlanet = this.getPlanetUnderMouse();
                if (this.rotatingPlanet) {
                    this.isRotatingPlanet = true;
                    this.rotatingPlanet.startRotation(event.clientX, event.clientY);
                    document.getElementById('space-canvas').classList.add('planet-rotating');
                }
            }

            onMouseMove(event) {
                this.mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                this.mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

                if (this.lastMousePos.x !== undefined && this.lastMousePos.y !== undefined) {
                    const deltaX = event.clientX - this.lastMousePos.x;
                    const deltaY = event.clientY - this.lastMousePos.y;
                    
                    this.dragDistance += Math.abs(deltaX) + Math.abs(deltaY);
                    
                    if (this.dragDistance > 5) {
                        this.isDragging = true;
                    }
                    
                    if (this.isDragging) {
                        if (this.isRotatingPlanet && this.rotatingPlanet) {
                            this.rotatingPlanet.updateRotation(event.clientX, event.clientY);
                        }
                    }
                    
                    this.lastMousePos.x = event.clientX;
                    this.lastMousePos.y = event.clientY;
                }

                if (!this.isDragging && !this.isRotatingPlanet) {
                    this.checkInteractionHover();
                }
            }

            onMouseUp() {
                if (this.isRotatingPlanet && this.rotatingPlanet) {
                    this.rotatingPlanet.stopRotation();
                    this.isRotatingPlanet = false;
                    this.rotatingPlanet = null;
                    document.getElementById('space-canvas').classList.remove('planet-rotating');
                }
                
                this.isDragging = false;
                this.dragDistance = 0;
                this.lastMousePos.x = undefined;
                this.lastMousePos.y = undefined;
            }

            onMouseClick(event) {
                const clickDuration = Date.now() - this.mouseDownTime;
                
                setTimeout(() => {
                    if (this.dragDistance < 5 && clickDuration < 200 && !this.isRotatingPlanet) {
                        this.checkInteractionClick();
                    }
                }, 10);
            }

            getPlanetUnderMouse() {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                
                for (let planet of this.planets) {
                    const intersects = this.raycaster.intersectObject(planet.getGroup(), true);
                    if (intersects.length > 0) {
                        return planet;
                    }
                }
                return null;
            }

            checkInteractionHover() {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                let hoveredObject = null;
                
                // Check planets
                this.planets.forEach(planet => {
                    const intersects = this.raycaster.intersectObject(planet.getGroup(), true);
                    
                    if (intersects.length > 0) {
                        hoveredObject = planet;
                        if (!planet.isHovered) {
                            planet.onHover(true);
                            // USE ENHANCED POSITIONING SYSTEM
                            this.enhancedPositioning.showPlanetInfo(planet);
                        }
                    } else if (planet.isHovered) {
                        planet.onHover(false);
                    }
                });
                
                // Check Portfolio Nebula
                if (!hoveredObject && this.portfolioNebula) {
                    const intersects = this.raycaster.intersectObject(this.portfolioNebula.getHitBox(), false);
                    if (intersects.length > 0) {
                        hoveredObject = this.portfolioNebula;
                        if (!this.portfolioNebula.isHovered) {
                            this.portfolioNebula.onHover(true);
                            // USE ENHANCED POSITIONING SYSTEM
                            this.enhancedPositioning.showNebulaInfo(this.portfolioNebula);
                        }
                    } else if (this.portfolioNebula.isHovered) {
                        this.portfolioNebula.onHover(false);
                    }
                }
                
                // ENHANCED CURSOR MANAGEMENT
                    const canvas = document.getElementById('space-canvas');
                    if (hoveredObject) {
                        // Add class for CSS-based cursor control
                        canvas.classList.add('hovering-interactive');
                        // Fallback for direct style setting
                        document.body.style.cursor = 'pointer';
                    } else {
                        // Remove class and reset cursor
                        canvas.classList.remove('hovering-interactive');
                        document.body.style.cursor = 'default';
                        // USE ENHANCED POSITIONING SYSTEM
                        this.enhancedPositioning.hidePlanetInfo();
                    }
            }

            checkInteractionClick() {
                this.raycaster.setFromCamera(this.mouse, this.camera);
                
                // Check planets first
                for (const planet of this.planets) {
                    const intersects = this.raycaster.intersectObject(planet.getGroup(), true);
                    
                    if (intersects.length > 0) {
                        // Use travel system if not currently traveling
                        if (this.travelSystem && !this.travelSystem.isTraveling()) {
                            console.log(`üåç Initiating travel to ${planet.getInfo().name}`);
                            this.travelSystem.initiatePlanetTravel(planet);
                        }
                        return;
                    }
                }
                
                // Check Portfolio Nebula
                if (this.portfolioNebula) {
                    const intersects = this.raycaster.intersectObject(this.portfolioNebula.getHitBox(), false);
                    if (intersects.length > 0) {
                        this.portfolioNebula.onClick();
                        return;
                    }
                }
            }

            // CONTENT METHODS WITH ENHANCED MODAL UPDATES
            updateContentModalWithPlanet(title, content, planetId) {
                updateContentModal(title, content, planetId);
            }

            getWorkContent() {
                return this.contentManager.getWorkContent();
            }

            getEducationContent() {
                return this.contentManager.getEducationContent();
            }

            getSkillsContent() {
                return this.contentManager.getSkillsContent();
            }

            getProjectsContent() {
                return this.contentManager.getProjectsContent();
            }

            getCommunityContent() {
                return this.contentManager.getCommunityContent();
            }

            getContactContent() {
                return this.contentManager.getContactContent();
            }

            // PORTFOLIO CONTENT METHOD - This is the key addition
            getPortfolioContent() {
                console.log('üì± Getting portfolio content...');
                
                // Initialize portfolio viewer if not already done
                if (!this.portfolioViewer) {
                    console.log('üñºÔ∏è Initializing Portfolio Viewer...');
                    this.portfolioViewer = new PortfolioViewer();
                }
                
                // Check if portfolio is ready
                if (!this.portfolioViewer.isReady()) {
                    console.log('‚è≥ Portfolio not ready, showing loading state...');
                    return `
                        <div class="portfolio-loading">
                            <div class="portfolio-loading-spinner"></div>
                            <h3>Loading Portfolio...</h3>
                            <p>Preparing creative showcase...</p>
                        </div>
                    `;
                }
                
                // Return the portfolio content
                console.log('‚úÖ Portfolio ready, returning content...');
                return this.portfolioViewer.getPortfolioContent();
            }

            showContent() {
                const contentOverlay = document.getElementById('content-overlay');
                contentOverlay.classList.remove('hidden');
            }

            hideContent() {
                const contentOverlay = document.getElementById('content-overlay');
                contentOverlay.classList.add('hidden');
                this.currentContent = null;
            }

            // ANIMATION RESTART METHODS FOR TRAVEL SYSTEM
            restartAnimations() {
                console.log('üé¨ Restarting all app animations...');
                
                // Restart planet animations
                if (this.planets) {
                    this.planets.forEach(planet => {
                        if (planet && planet.clock) {
                            planet.clock.start();
                        }
                        
                        // Reset animation states
                        if (planet.baseScale !== undefined) {
                            planet.baseScale = 1.0;
                            planet.targetScale = 1.0;
                        }
                        
                        // Reset rotation states
                        if (planet.isRotating !== undefined) {
                            planet.isRotating = false;
                        }
                        
                        // Reset hover states
                        if (planet.isHovered !== undefined) {
                            planet.isHovered = false;
                        }
                    });
                }
                
                // Restart spaceship animations
                if (this.spaceship && this.spaceship.clock) {
                    this.spaceship.clock.start();
                }
                
                // Restart nebula animations
                if (this.portfolioNebula && this.portfolioNebula.clock) {
                    this.portfolioNebula.clock.start();
                }
                
                // Ensure animation loop is running
                this.startAnimationLoop();
                
                console.log('‚úÖ All app animations restarted');
            }

            startAnimationLoop() {
                console.log('üé¨ Ensuring animation loop is running...');
                // The animation loop is already running in startAnimation method
                // This method ensures it continues running
                if (!this.animationRunning) {
                    this.animationRunning = true;
                    this.startAnimation();
                }
            }

            enableInteractions() {
                console.log('üéÆ Re-enabling all interactions...');
                
                // Re-setup mouse event listeners
                this.setupInteractions();
                
                // Ensure raycaster is working
                if (this.raycaster) {
                    // Reset raycaster if needed
                    this.raycaster = new THREE.Raycaster();
                }
                
                // Reset any interaction states
                this.hoveredPlanet = null;
                this.isDragging = false;
                this.isRotatingPlanet = false;
                this.rotatingPlanet = null;
                
                // Reset mouse state
                this.mouse = { x: 0, y: 0 };
                this.dragDistance = 0;
                
                console.log('‚úÖ All interactions re-enabled');
            }

            setupInteractions() {
                console.log('üñ±Ô∏è Setting up fresh planet interactions...');
                
                // Remove existing event listeners to prevent duplicates
                const canvas = document.getElementById('space-canvas');
                if (canvas) {
                    // Remove old listeners (if they exist)
                    if (this.boundMouseDown) {
                        canvas.removeEventListener('mousedown', this.boundMouseDown);
                        canvas.removeEventListener('mousemove', this.boundMouseMove);
                        canvas.removeEventListener('mouseup', this.boundMouseUp);
                        canvas.removeEventListener('click', this.boundMouseClick);
                    }
                    
                    // Create new bound methods
                    this.boundMouseDown = this.onMouseDown.bind(this);
                    this.boundMouseMove = this.onMouseMove.bind(this);
                    this.boundMouseUp = this.onMouseUp.bind(this);
                    this.boundMouseClick = this.onMouseClick.bind(this);
                    
                    // Add fresh listeners
                    canvas.addEventListener('mousedown', this.boundMouseDown);
                    canvas.addEventListener('mousemove', this.boundMouseMove);
                    canvas.addEventListener('mouseup', this.boundMouseUp);
                    canvas.addEventListener('click', this.boundMouseClick);
                    
                    // Ensure canvas is interactive
                    canvas.style.pointerEvents = 'auto';
                    
                    console.log('‚úÖ Fresh interaction listeners added');
                }
            }

            checkAnimationHealth() {
                // Call this occasionally to ensure animations are still running
                if (this.planets) {
                    this.planets.forEach((planet, index) => {
                        if (planet && planet.clock && !planet.clock.running) {
                            console.warn(`‚ö†Ô∏è Planet ${index} animation stopped, restarting...`);
                            planet.clock.start();
                        }
                        
                        // Ensure planet is visible
                        const group = planet.getGroup();
                        if (group && !group.visible) {
                            console.warn(`‚ö†Ô∏è Planet ${index} became invisible, restoring...`);
                            group.visible = true;
                        }
                    });
                }
                
                // Check spaceship
                if (this.spaceship && this.spaceship.clock && !this.spaceship.clock.running) {
                    console.warn('‚ö†Ô∏è Spaceship animation stopped, restarting...');
                    this.spaceship.clock.start();
                }
                
                // Check nebula
                if (this.portfolioNebula && this.portfolioNebula.clock && !this.portfolioNebula.clock.running) {
                    console.warn('‚ö†Ô∏è Nebula animation stopped, restarting...');
                    this.portfolioNebula.clock.start();
                }
            }

            startAnimation() {
                this.animationRunning = true;
                let frameCount = 0;
                
                const animate = () => {
                    if (!this.animationRunning) return;
                    
                    frameCount++;
                    
                    // Update planets
                    this.planets.forEach(planet => {
                        if (planet && planet.update) {
                            planet.update();
                        }
                    });
                    
                    // Update Portfolio Nebula
                    if (this.portfolioNebula && this.portfolioNebula.update) {
                        this.portfolioNebula.update();
                    }
                    
                    // Update spaceship
                    if (this.spaceship && this.spaceship.update) {
                        this.spaceship.update();
                    }
                    
                    // UPDATE TRAVEL SYSTEM
                    if (this.travelSystem) {
                        this.travelSystem.update();
                    }
                    
                    // Check animation health every 300 frames (about every 5 seconds at 60fps)
                    if (frameCount % 300 === 0) {
                        this.checkAnimationHealth();
                    }
                    
                    this.renderer.render(this.scene, this.camera);
                    requestAnimationFrame(animate);
                };
                animate();
            }

            showWebGLError() {
                const webglError = document.getElementById('webgl-error');
                const loadingScreen = document.getElementById('loading-screen');
                
                if (webglError) {
                    webglError.classList.remove('hidden');
                }
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            }

            dispose() {
                this.animationRunning = false;
                
                this.planets.forEach(planet => {
                    if (planet && planet.dispose) {
                        planet.dispose();
                    }
                });
                
                if (this.portfolioNebula && this.portfolioNebula.dispose) {
                    this.portfolioNebula.dispose();
                }
                
                if (this.spaceship && this.spaceship.dispose) {
                    this.spaceship.dispose();
                }
                
                if (this.travelSystem && this.travelSystem.dispose) {
                    this.travelSystem.dispose();
                }
                
                if (this.portfolioViewer && this.portfolioViewer.dispose) {
                    this.portfolioViewer.dispose();
                }
                
                if (this.renderer) {
                    this.renderer.dispose();
                }
            }
        }

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Starting Complete Space CV Application...');
            
            // Create the application
            window.spaceCVApp = new CompletSpaceCVApp();
            
            // SETUP RETURN TO ORBIT EVENT HANDLER
            setupReturnToOrbitHandler();
            
            console.log('‚úÖ Application initialized with enhanced modal styling and positioning');
            // NAVIGATION MINIMIZATION SYSTEM
function setupNavigationMinimization() {
    const navigationPanel = document.getElementById('controls-info');
    const mobileToggle = document.getElementById('mobile-nav-toggle');
    let minimizeTimer = null;
    let isMinimized = false;
    let isMobile = window.innerWidth <= 768;
    
    // Update mobile detection on resize
    window.addEventListener('resize', () => {
        isMobile = window.innerWidth <= 768;
    });
    
    // Start expanded, then auto-minimize after 5 seconds on first load
console.log('üîº Navigation starts expanded for 5 seconds');
minimizeTimer = setTimeout(() => {
    if (navigationPanel) {
        navigationPanel.classList.add('minimized');
        isMinimized = true;
        console.log('üîΩ Navigation auto-minimized after 5 seconds');
    }
}, 7000);
    
    // Desktop hover behavior
    if (navigationPanel) {
        navigationPanel.addEventListener('mouseenter', () => {
            if (!isMobile) {
                navigationPanel.classList.remove('minimized');
                isMinimized = false;
                console.log('üîº Navigation expanded on hover');
            }
        });
        
        navigationPanel.addEventListener('mouseleave', () => {
            if (!isMobile) {
                navigationPanel.classList.add('minimized');
                isMinimized = true;
                console.log('üîΩ Navigation minimized on mouse leave');
            }
        });
    }
    
    // Mobile button behavior
    if (mobileToggle) {
        mobileToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            
            if (isMinimized) {
                navigationPanel.classList.remove('minimized');
                navigationPanel.classList.add('expanded');
                isMinimized = false;
                console.log('üîº Navigation expanded via mobile button');
            } else {
                navigationPanel.classList.add('minimized');
                navigationPanel.classList.remove('expanded');
                isMinimized = true;
                console.log('üîΩ Navigation minimized via mobile button');
            }
        });
    }
    
    console.log('‚úÖ Navigation minimization system setup complete');
}

// Call the setup function
setupNavigationMinimization();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (window.spaceCVApp) {
                window.spaceCVApp.dispose();
            }
        });

        // Global error handlers
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>